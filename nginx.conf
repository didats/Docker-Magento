events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    upstream fastcgi_backend {
        server php:9000;
    }

    server {
        listen 80;
        server_name _;
        
        set $MAGE_ROOT /var/www/html;
        
        root $MAGE_ROOT/pub;
        
        index index.php;
        autoindex off;
        charset UTF-8;
        error_page 404 403 = /errors/404.php;
        
        # Static content
        location /static/ {
            alias $MAGE_ROOT/pub/static/;
            
            # Remove signature of the static files that is used to overcome the browser cache
            location ~ ^/static/version\d+/ {
                rewrite ^/static/version\d+/(.*)$ /static/$1 last;
            }
            
            location ~* \.(ico|jpg|jpeg|png|gif|svg|js|css|swf|eot|ttf|otf|woff|woff2|html|json)$ {
                add_header Cache-Control "public";
                add_header X-Frame-Options "SAMEORIGIN";
                expires +1y;
                
                if (!-f $request_filename) {
                    rewrite ^/static/?(.*)$ /static.php?resource=$1 last;
                }
            }
            
            location ~* \.(zip|gz|gzip|bz2|csv|xml)$ {
                add_header Cache-Control "no-store";
                add_header X-Frame-Options "SAMEORIGIN";
                expires off;
                
                if (!-f $request_filename) {
                    rewrite ^/static/?(.*)$ /static.php?resource=$1 last;
                }
            }
            
            if (!-f $request_filename) {
                rewrite ^/static/?(.*)$ /static.php?resource=$1 last;
            }
            
            add_header X-Frame-Options "SAMEORIGIN";
        }

        # Media files
        location /media/ {
            alias $MAGE_ROOT/pub/media/;
            
            try_files $uri $uri/ /get.php$is_args$args;
            
            location ~ ^/media/theme_customization/.*\.xml$ {
                deny all;
            }
            
            location ~* \.(ico|jpg|jpeg|png|gif|svg|js|css|swf|eot|ttf|otf|woff|woff2)$ {
                add_header Cache-Control "public";
                add_header X-Frame-Options "SAMEORIGIN";
                expires +1y;
                try_files $uri $uri/ /get.php$is_args$args;
            }
            
            location ~* \.(zip|gz|gzip|bz2|csv|xml)$ {
                add_header Cache-Control "no-store";
                add_header X-Frame-Options "SAMEORIGIN";
                expires off;
                try_files $uri $uri/ /get.php$is_args$args;
            }
            
            add_header X-Frame-Options "SAMEORIGIN";
        }

        # Handle .php files (this must come before the deny rules)
        location ~ \.php$ {
            try_files $uri =404;
            fastcgi_pass fastcgi_backend;
            fastcgi_buffers 16 16k;
            fastcgi_buffer_size 32k;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_read_timeout 600s;
            fastcgi_connect_timeout 600s;
            include fastcgi_params;
        }

        # Main application (this should come after PHP handling)
        location / {
            try_files $uri $uri/ /index.php$is_args$args;
        }

        # Deny access to sensitive files (this should be last)
        location ~* (\.htaccess$|\.git) {
            deny all;
        }
        
        location ~ /\. {
            deny all;
        }
    }
}
